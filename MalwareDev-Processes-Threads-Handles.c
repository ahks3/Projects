//This code was written following concepts in the Youtube video, "Malware Development: Processes, Threads, and Handles" by Crow. Many additions were made for my own learning. Written in VSCode
#include <Windows.h> //Referencing Windows API Documentation for CreateProcess, MessageBox, TerminateProcess
#include <stdio.h>
#include <stdlib.h>

DWORD getErrFunc (char* category) //Simple function to speed up implementation of error checking
{
	printf("Failed during %s, error code %ld", category, GetLastError());
}

int main(void)
{
	STARTUPINFO strtInfo = { 0 }; //Initialize and set to 0 needed for process creation
	PROCESS_INFORMATION prcInfo = { 0 };

	strtInfo.cb = sizeof(strtInfo); //Ensure correct memory allocation size

	if (!CreateProcess( //Create wireshark.exe process
		"C:\\Program Files\\Wireshark\\wireshark.exe",
		NULL,
		NULL,
		NULL,
		NULL,
		NULL,
		NULL,
		NULL,
		&strtInfo,
		&prcInfo)) {
			getErrFunc("process creation");
			return EXIT_FAILURE;
	};

	WaitForSingleObject(prcInfo.hProcess, 10000); //Wait for program to start

	HANDLE procHandle = prcInfo.hProcess; //Getting easy access to handle/thread/ PID
	DWORD procID = prcInfo.dwProcessId;
	DWORD thrdID = prcInfo.dwThreadId;

	if (procHandle == NULL || procHandle == INVALID_HANDLE_VALUE) { //Check for invalid or null process handle
		printf("Invalid process handle");
		return EXIT_FAILURE;
	}

	char tempMsg[250];
	snprintf(tempMsg, sizeof(tempMsg), "Close PID %lu?", procID);

	int msgInput = MessageBox( //Create messagebox to close process
		NULL, 
		tempMsg,
		"ALERT",
		MB_OKCANCEL); // Ok 1 Cancel 2

	if (! msgInput) { //Check to ensure message box is created and response is received
			getErrFunc("message box creation");
			return EXIT_FAILURE;
	}
	
	if (msgInput == 1){ //Check to see if User chooses OK to close process
		if (! TerminateProcess(procHandle, NULL)){ //Check to see if process terminates
			getErrFunc("process termination");
			return EXIT_FAILURE;
		}
		if (! CloseHandle(procHandle) && CloseHandle(thrdID)){ // Check to see if handle/thread closes
			getErrFunc("process and thread closing");
			return EXIT_FAILURE;
		}
		return EXIT_SUCCESS; //Process exits and program returns success after checking to ensure termination and closed process handles
	}
	
	return EXIT_SUCCESS; //Program returns success due to User choosing not to close Process
};